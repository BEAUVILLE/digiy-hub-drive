<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY ‚ôæÔ∏è JOBS ‚Äî Offres disponibles</title>
  <meta name="theme-color" content="#16a34a"/>
  <meta name="description" content="Trouvez votre prochain emploi sur DIGIY JOBS ‚Äî Contact direct avec les recruteurs"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --green:#16a34a; --green2:#22c55e;
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.78); --dark:#052e16;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background: radial-gradient(900px 500px at 10% -10%, rgba(34,197,94,.20), transparent 60%), var(--bg);
      color:var(--text);
    }
    header{
      padding:16px;
      border-bottom:1px solid var(--line);
      background:rgba(6,27,20,.72);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      font-weight:950;
      letter-spacing:.1em;
    }
    .brand small{
      display:block;
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:0;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .btn{
      border:none;
      cursor:pointer;
      border-radius:14px;
      padding:10px 14px;
      font-weight:950;
      font-size:14px;
    }
    .btn.ghost{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
    }
    .btn.primary{
      background:linear-gradient(135deg,var(--green),var(--green2));
      color:var(--dark);
    }
    main{
      max-width:900px;
      margin:0 auto;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .filters{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    select, input{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#052e16;
      color:var(--text);
      font-weight:800;
      font-size:14px;
      outline:none;
    }
    .pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      font-weight:950;
      font-size:13px;
    }
    .job-card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
    }
    .job-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .job-title{
      font-weight:950;
      font-size:18px;
      line-height:1.3;
    }
    .company{
      color:var(--muted);
      font-weight:800;
      font-size:14px;
      margin-top:4px;
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(34,197,94,.12);
      font-weight:950;
      font-size:12px;
      white-space:nowrap;
    }
    .job-meta{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin:12px 0;
      font-size:13px;
      font-weight:850;
      color:var(--muted);
    }
    .job-description{
      margin:12px 0;
      line-height:1.6;
      color:var(--muted);
      font-weight:800;
      font-size:14px;
    }
    .requirements{
      margin-top:12px;
      padding:12px;
      background:rgba(0,0,0,.2);
      border-radius:12px;
      font-size:13px;
      line-height:1.5;
      color:var(--muted);
    }
    .job-actions{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .empty{
      text-align:center;
      padding:40px 20px;
      color:var(--muted);
      font-weight:900;
    }
    footer{
      text-align:center;
      padding:16px 10px;
      font-size:12px;
      font-weight:800;
      color:rgba(234,255,241,.72);
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(6,27,20,.55);
    }
    a{
      color:#86efac;
      text-decoration:none;
      font-weight:950;
    }
  </style>
</head>

<body>

<header>
  <div class="brand">
    ‚ôæÔ∏è DIGIY JOBS
    <small>Offres d'emploi ‚Äî Contact direct</small>
  </div>
  <div class="row">
    <button class="btn ghost" onclick="location.reload()">‚Üª Rafra√Æchir</button>
    <button class="btn ghost" onclick="location.href='index.html'">‚Üê HUB</button>
  </div>
</header>

<main>

  <div class="filters">
    <select id="filterType" onchange="applyFilters()">
      <option value="">Tous les types</option>
      <option value="CDI">CDI</option>
      <option value="CDD">CDD</option>
      <option value="Stage">Stage</option>
      <option value="Freelance">Freelance</option>
      <option value="Int√©rim">Int√©rim</option>
      <option value="Alternance">Alternance</option>
    </select>

    <input id="filterLocation" type="text" placeholder="üîç Rechercher une ville..." onkeyup="applyFilters()"/>

    <div class="pill" id="countPill">‚Äî</div>
  </div>

  <div id="jobsList"></div>

</main>

<footer>
  DIGIYLYFE ‚ôæÔ∏è ‚Äî direct au peuple ‚Ä¢ 0% commission ‚Ä¢
  <a href="index.html">Retour HUB</a>
</footer>

<script>
/* =========================
   SUPABASE
========================= */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

const SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   STATE
========================= */
let allJobs = [];
let filteredJobs = [];

/* =========================
   HELPERS
========================= */
function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function cleanPhone(p){
  const raw = String(p||"").trim();
  const plus = raw.startsWith("+") ? "+" : "";
  const digits = raw.replace(/[^\d]/g,"");
  return plus + digits;
}

function timeAgo(dateStr){
  const diff = Math.floor((Date.now() - new Date(dateStr).getTime()) / 86400000);
  if(diff <= 0) return "Aujourd'hui";
  if(diff === 1) return "Hier";
  if(diff < 7) return `Il y a ${diff}j`;
  if(diff < 30) return `Il y a ${Math.floor(diff/7)} sem.`;
  return `Il y a ${Math.floor(diff/30)} mois`;
}

/* =========================
   RENDER
========================= */
function renderJobs(jobs){
  const listEl = document.getElementById("jobsList");
  const countPill = document.getElementById("countPill");

  countPill.textContent = `${jobs.length} offre${jobs.length > 1 ? "s" : ""}`;

  if(!jobs || jobs.length === 0){
    listEl.innerHTML = `<div class="empty">Aucune offre disponible pour l'instant.<br>Revenez bient√¥t ! üöÄ</div>`;
    return;
  }

  listEl.innerHTML = "";

  jobs.forEach(job=>{
    const phone = cleanPhone(job.recruiter_phone);

    const div = document.createElement("div");
    div.className = "job-card";

    const salaryHtml = job.salary_range 
      ? `<span>üí∞ ${esc(job.salary_range)}</span>` 
      : "";

    const reqHtml = job.requirements 
      ? `<div class="requirements"><strong>Profil recherch√© :</strong><br>${esc(job.requirements).replace(/\n/g,"<br>")}</div>` 
      : "";

    div.innerHTML = `
      <div class="job-header">
        <div>
          <div class="job-title">${esc(job.job_title)}</div>
          <div class="company">üè¢ ${esc(job.company_name)}</div>
        </div>
        <span class="badge">${esc(job.job_type)}</span>
      </div>

      <div class="job-meta">
        <span>üìç ${esc(job.location)}</span>
        ${salaryHtml}
        <span>üïí ${timeAgo(job.created_at)}</span>
      </div>

      <div class="job-description">
        ${esc(job.description).replace(/\n/g,"<br>")}
      </div>

      ${reqHtml}

      <div class="job-actions">
        <button class="btn primary" onclick="contactRecruiter('${esc(phone)}', '${esc(job.job_title)}', '${esc(job.company_name)}')">
          üìû Postuler / Contacter
        </button>
      </div>
    `;

    listEl.appendChild(div);
  });
}

/* =========================
   FILTERS
========================= */
function applyFilters(){
  const typeFilter = document.getElementById("filterType").value;
  const locationFilter = document.getElementById("filterLocation").value.toLowerCase().trim();

  filteredJobs = allJobs.filter(job => {
    const matchType = !typeFilter || job.job_type === typeFilter;
    const matchLocation = !locationFilter || (job.location||"").toLowerCase().includes(locationFilter);
    return matchType && matchLocation;
  });

  renderJobs(filteredJobs);
}

/* =========================
   LOAD
========================= */
async function loadJobs(){
  try{
    const { data, error } = await SB
      .from("job_offers")
      .select("*")
      .eq("status", "approved")
      .order("created_at", { ascending: false })
      .limit(100);

    if(error){
      console.error("Erreur Supabase:", error);
      document.getElementById("jobsList").innerHTML = 
        `<div class="empty">‚ùå Erreur de chargement.<br>R√©essayez plus tard.</div>`;
      return;
    }

    allJobs = data || [];
    filteredJobs = allJobs;
    renderJobs(filteredJobs);

  }catch(err){
    console.error("Erreur:", err);
    document.getElementById("jobsList").innerHTML = 
      `<div class="empty">‚ùå Une erreur est survenue.</div>`;
  }
}

/* =========================
   CONTACT
========================= */
function contactRecruiter(phone, jobTitle, company){
  if(!phone){
    alert("‚ö†Ô∏è Num√©ro de contact indisponible.");
    return;
  }

  const message = `Salam ! Je suis int√©ress√©(e) par l'offre "${jobTitle}" chez ${company} sur DIGIY JOBS.`;
  const waLink = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;

  window.open(waLink, "_blank");
}

/* =========================
   START
========================= */
loadJobs();
</script>

</body>
</html>
