
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY J√ãF ‚Äî Jobs & Missions</title>
  <meta name="theme-color" content="#16a34a"/>

  <!-- ‚úÖ Supabase (1 seule fois) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --green:#16a34a;
      --bg:#061b14;
      --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.12);
      --text:#eafff1;
      --muted:rgba(234,255,241,.75);
      --dark:#052e16;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(34,197,94,.25), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(6,27,20,.72);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
      padding:14px;
    }
    .top{
      max-width:980px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{font-weight:950; letter-spacing:.08em}
    .brand small{display:block; font-weight:800; letter-spacing:0; opacity:.8; margin-top:2px}
    .btn{
      border:none; border-radius:14px; padding:10px 12px;
      font-weight:950; cursor:pointer;
    }
    .btn-primary{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:var(--dark);
    }
    .btn-ghost{
      background:transparent; color:var(--text);
      border:1px solid var(--line);
    }
    main{max-width:980px; margin:0 auto; padding:14px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:0 18px 40px rgba(0,0,0,.18);
    }
    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:7px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.14);
      font-weight:900; font-size:12px;
    }

    /* ===== Clarification J√ãF vs JOBS PRO ===== */
    .digiy-clarify{
      margin-top:12px;
      background:rgba(236,253,245,.10);
      border:1px solid rgba(187,247,208,.28);
      border-radius:16px;
      padding:12px;
    }
    .digiy-clarify-title{
      font-weight:950;
      letter-spacing:.06em;
      color:rgba(134,239,172,.95);
    }
    .digiy-clarify-text{
      margin-top:6px;
      color:rgba(234,255,241,.88);
      font-weight:800;
      line-height:1.35;
    }
    .digiy-clarify-actions{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .digiy-clarify-btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 12px; border-radius:14px;
      font-weight:950; text-decoration:none;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:#052e16;
    }
    .digiy-clarify-link{
      background:transparent;
      border:1px solid rgba(255,255,255,.14);
      color:rgba(234,255,241,.9);
      padding:10px 12px; border-radius:14px;
      font-weight:900; cursor:pointer;
    }
    .digiy-clarify-faq{
      margin-top:10px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px;
      color:rgba(234,255,241,.88);
      font-weight:800;
      line-height:1.35;
      display:none;
    }

    /* ===== NDIMBAL Context ===== */
    .ndimb{
      margin-top:12px;
      background:rgba(250,204,21,.10);
      border:1px solid rgba(250,204,21,.22);
      border-radius:16px;
      padding:12px;
    }
    .ndimb h3{
      margin:0;
      font-weight:950;
      letter-spacing:.06em;
      color:rgba(250,204,21,.95);
      font-size:14px;
    }
    .ndimb p{
      margin:8px 0 0;
      color:rgba(234,255,241,.9);
      font-weight:850;
      line-height:1.35;
    }
    .ndimb .actions{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap;
    }

    .filters{
      display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px;
    }
    @media(max-width:700px){ .filters{grid-template-columns:1fr} }

    input,select,textarea{
      width:100%; padding:12px; border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text); outline:none; font-weight:800;
    }
    textarea{min-height:88px; resize:vertical}

    .list{display:grid; gap:10px; margin-top:12px}
    .mission{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
    }
    .m-title{font-weight:950; font-size:15px}
    .m-meta{
      margin-top:6px; display:flex; gap:10px; flex-wrap:wrap;
      color:var(--muted); font-weight:800; font-size:13px;
    }
    .m-actions{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap}
    a{color:#86efac; text-decoration:none; font-weight:950}

    .footer{
      text-align:center; color:rgba(234,255,241,.65);
      font-weight:800; padding:20px 10px;
    }

    /* ===== Modal Publish ===== */
    .modal{
      position:fixed; inset:0; z-index:50;
      display:none;
      background:rgba(0,0,0,.55);
      backdrop-filter:blur(6px);
      padding:14px;
    }
    .modal.open{display:flex; align-items:center; justify-content:center}
    .modal-card{
      width:min(720px, 100%);
      background:rgba(6,27,20,.95);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      padding:14px;
    }
    .modal-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      padding-bottom:10px;
    }
    .modal-title{font-weight:950; letter-spacing:.06em}
    .modal-close{
      border:1px solid rgba(255,255,255,.14);
      background:transparent; color:var(--text);
      border-radius:12px; padding:8px 10px; font-weight:950; cursor:pointer;
    }
    .grid{
      margin-top:12px;
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    @media(max-width:700px){ .grid{grid-template-columns:1fr} }
    .hint{
      margin-top:10px;
      color:rgba(234,255,241,.78);
      font-weight:850;
      line-height:1.35;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
    }
    .danger{
      margin-top:10px;
      background:rgba(239,68,68,.12);
      border:1px solid rgba(239,68,68,.22);
      border-radius:14px;
      padding:10px;
      color:rgba(255,230,230,.95);
      font-weight:900;
      display:none;
    }
  </style>
</head>
<body>

<header>
  <div class="top">
    <div class="brand">‚ôæÔ∏è DIGIY J√ãF
      <small>Missions rapides ‚Ä¢ terrain ‚Ä¢ WhatsApp direct</small>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
      <button class="btn btn-ghost" id="btn-home" type="button">‚Üê HUB</button>
      <button class="btn btn-primary" id="btn-new" type="button">+ Publier</button>
    </div>
  </div>
</header>

<main>
  <div class="card">
    <div class="row">
      <div>
        <div style="font-weight:950">Trouver une mission</div>
        <div id="toast" class="pill">Chargement‚Ä¶</div>
      </div>
      <div class="pill" id="countPill">0 mission</div>
    </div>

    <!-- ‚ôæÔ∏è NDIMBAL Context (HUB ‚Üí J√ãF) -->
    <div class="ndimb" id="ndimbBox" style="display:none">
      <h3>‚ôæÔ∏è NDIMBAL ‚Äî Demande venue du HUB</h3>
      <p id="ndimbText">Contexte‚Ä¶</p>
      <div class="actions">
        <button class="btn btn-primary" id="btn-use-ctx" type="button">Publier cette mission</button>
        <button class="btn btn-ghost" id="btn-clear-ctx" type="button">Ignorer</button>
      </div>
    </div>

    <!-- üîé Clarification -->
    <div class="digiy-clarify">
      <div class="digiy-clarify-title">‚ôæÔ∏è DIGIY J√ãF vs DIGIY JOBS PRO</div>
      <div class="digiy-clarify-text">
        <b>J√ãF</b> : missions rapides, annonces simples, ouvertes √† tous.<br/>
        <b>JOBS PRO</b> : recrutement structur√©, gestion pro, candidats qualifi√©s.
      </div>
      <div class="digiy-clarify-actions">
        <a class="digiy-clarify-btn" id="btn-jobs-pro" href="#">Ouvrir DIGIY JOBS PRO</a>
        <button class="digiy-clarify-link" id="btn-why" type="button">Pourquoi deux ?</button>
      </div>
      <div class="digiy-clarify-faq" id="clarify-faq">
        <div><b>Quand j‚Äôutilise J√ãF ?</b> Pour du ponctuel : 2h, 1 jour, urgence.</div>
        <div style="margin-top:6px"><b>Quand j‚Äôutilise JOBS PRO ?</b> Pour recruter souvent, avec suivi et tri.</div>
      </div>
    </div>

    <!-- üîç Filtres -->
    <div class="filters">
      <div>
        <input id="q" placeholder="Ex: livraison, m√©nage, peinture, d√©pannage‚Ä¶"/>
      </div>
      <div>
        <select id="zone">
          <option value="">Toutes zones</option>
          <option value="Saly">Saly</option>
          <option value="Dakar">Dakar</option>
          <option value="Mbour">Mbour</option>
          <option value="Thi√®s">Thi√®s</option>
          <option value="Autre">Autre</option>
        </select>
      </div>
    </div>

    <div class="list" id="list"></div>
  </div>

  <div class="footer">
    DIGIYLYFE ‚ôæÔ∏è ‚Äî direct au peuple ‚Ä¢ 0% commission ‚Ä¢ <a href="#" id="footerHub">Retour HUB</a>
  </div>
</main>

<!-- ‚úÖ Modal Publish -->
<div class="modal" id="modal">
  <div class="modal-card">
    <div class="modal-head">
      <div>
        <div class="modal-title">+ Publier une mission (J√ãF)</div>
        <div style="margin-top:4px;color:rgba(234,255,241,.75);font-weight:850">
          Simple, direct, terrain.
        </div>
      </div>
      <button class="modal-close" id="modalClose" type="button">Fermer</button>
    </div>

    <div class="grid">
      <div>
        <label style="font-weight:900;opacity:.9">Titre mission</label>
        <input id="f_title" placeholder="Ex: Aide d√©m√©nagement 2h, Livraison urgente‚Ä¶">
      </div>
      <div>
        <label style="font-weight:900;opacity:.9">Zone</label>
        <select id="f_zone">
          <option value="">Choisir zone</option>
          <option value="Saly">Saly</option>
          <option value="Dakar">Dakar</option>
          <option value="Mbour">Mbour</option>
          <option value="Thi√®s">Thi√®s</option>
          <option value="Autre">Autre</option>
        </select>
      </div>
      <div>
        <label style="font-weight:900;opacity:.9">T√©l√©phone (WhatsApp)</label>
        <input id="f_phone" placeholder="+221 77 000 00 00">
      </div>
      <div>
        <label style="font-weight:900;opacity:.9">Statut</label>
        <select id="f_status">
          <option value="pending">En attente (pending)</option>
          <option value="approved">Publi√© (approved)</option>
        </select>
      </div>
    </div>

    <div style="margin-top:10px">
      <label style="font-weight:900;opacity:.9">D√©tails</label>
      <textarea id="f_note" placeholder="Infos utiles : dur√©e, prix, lieu pr√©cis, urgence‚Ä¶"></textarea>
    </div>

    <div class="hint">
      ‚ö° Astuce : si ta s√©curit√© (RLS) n‚Äôautorise pas l‚Äôinsert, on affichera l‚Äôerreur clairement.
      Tu pourras ensuite choisir : soit autoriser l‚Äôinsertion publique, soit passer par ton serveur/API.
    </div>

    <div class="danger" id="publishError"></div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
      <button class="btn btn-ghost" id="btnDraft" type="button">Enregistrer en attente</button>
      <button class="btn btn-primary" id="btnPublish" type="button">Publier</button>
    </div>
  </div>
</div>

<script>
/* ======================================================
   ‚úÖ SUPABASE ‚Äî 1 SEULE FOIS (ANTI "already declared")
   - On utilise window.digiySupabase pour √©viter collisions
====================================================== */
(function initSupabaseOnce(){
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  if (!window.supabase || !window.supabase.createClient) {
    console.error("Supabase SDK introuvable. V√©rifie le script CDN.");
    return;
  }
  if (!window.digiySupabase) {
    window.digiySupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }
})();

/* ======================================================
   DIGIY J√ãF ‚Äî PUBLIC LIST + PUBLISH MODAL
   Table: public.jef_missions
   Colonnes attendues: title, zone, phone, note, status, created_at
====================================================== */
(function(){
  const supabase = window.digiySupabase;

  // ‚úÖ HUB link stable (GitHub pages / Hostinger)
  const basePath = location.pathname.includes("/digiy-hub/") ? "/digiy-hub/" : "/";

  const list = document.getElementById("list");
  const q = document.getElementById("q");
  const zone = document.getElementById("zone");
  const count = document.getElementById("countPill");
  const toast = document.getElementById("toast");

  const footerHub = document.getElementById("footerHub");
  footerHub.href = basePath;

  // ‚úÖ Boutons
  document.getElementById("btn-home").addEventListener("click", ()=> {
    location.href = basePath;
  });

  // JOBS PRO placeholder
  document.getElementById("btn-jobs-pro").href = basePath + "digiy-jobs-pro.html";

  // FAQ toggle
  document.getElementById("btn-why").addEventListener("click", ()=>{
    const faq = document.getElementById("clarify-faq");
    const open = (faq.style.display === "none" || !faq.style.display);
    faq.style.display = open ? "block" : "none";
  });

  // ===== Modal publish
  const modal = document.getElementById("modal");
  const modalClose = document.getElementById("modalClose");
  const publishError = document.getElementById("publishError");

  const f_title = document.getElementById("f_title");
  const f_zone = document.getElementById("f_zone");
  const f_phone = document.getElementById("f_phone");
  const f_note  = document.getElementById("f_note");
  const f_status= document.getElementById("f_status");

  function openModal(){
    publishError.style.display = "none";
    publishError.textContent = "";
    modal.classList.add("open");
  }
  function closeModal(){
    modal.classList.remove("open");
  }
  modalClose.addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

  document.getElementById("btn-new").addEventListener("click", ()=>{
    // si tu cr√©es publish-mission.html plus tard, tu pourras revenir √† ta redirection
    // l√†, on fait "toujours fonctionnel"
    openModal();
  });

  // ===== NDIMBAL context (HUB ‚Üí J√ãF)
  const ndimbBox = document.getElementById("ndimbBox");
  const ndimbText = document.getElementById("ndimbText");
  const btnUseCtx = document.getElementById("btn-use-ctx");
  const btnClearCtx = document.getElementById("btn-clear-ctx");

  function getCtx(){
    try{
      return JSON.parse(localStorage.getItem("digiy_jef_context") || "null");
    }catch(e){ return null; }
  }
  function clearCtx(){
    localStorage.removeItem("digiy_jef_context");
  }
  const ctx = getCtx();
  if(ctx && (ctx.action || ctx.from)){
    ndimbBox.style.display = "block";
    const action = ctx.action || "NDIMBAL";
    const from = ctx.from || "HUB";
    ndimbText.innerHTML = `Re√ßu: <b>${esc(action)}</b> depuis <b>${esc(from)}</b>. Tu veux publier une mission maintenant ?`;
  }

  btnClearCtx.addEventListener("click", ()=>{
    clearCtx();
    ndimbBox.style.display = "none";
  });

  btnUseCtx.addEventListener("click", ()=>{
    // pr√©remplit le formulaire depuis le contexte
    const c = getCtx() || {};
    f_title.value = (c.title || "‚ôæÔ∏è NDIMBAL ‚Äî Besoin d‚Äôaide");
    f_zone.value = (c.zone || "");
    f_note.value = (c.note || "Demande envoy√©e depuis le HUB (NDIMBAL).");
    f_status.value = "pending";
    openModal();
  });

  // ===== utils
  let cache = [];

  function norm(s){ return (s||"").toLowerCase(); }
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;",
      "<":"&lt;",
      ">":"&gt;",
      "\"":"&quot;",
      "'":"&#039;"
    }[m]));
  }
  function cleanPhone(p){
    const raw = String(p||"").trim();
    // garder + et chiffres
    const plus = raw.startsWith("+") ? "+" : "";
    const digits = raw.replace(/[^\d]/g,"");
    return plus + digits;
  }

  function render(){
    const qq = norm(q.value);
    const zz = zone.value;

    const filtered = cache.filter(m=>{
      const okQ = !qq || norm(m.title).includes(qq) || norm(m.note||"").includes(qq);
      const okZ = !zz || m.zone === zz;
      return okQ && okZ;
    });

    count.textContent = filtered.length + (filtered.length>1 ? " missions" : " mission");
    list.innerHTML = "";

    if(!filtered.length){
      list.innerHTML = `<div class="mission">
        <div class="m-title">Aucune mission</div>
        <div class="m-meta">Publie une mission ou change le filtre.</div>
      </div>`;
      return;
    }

    // ‚úÖ d√©dup simple (√©vite doublons visuels)
    const seen = new Set();

    filtered.forEach(m=>{
      const key = `${(m.title||"").trim()}|${(m.zone||"").trim()}|${(m.phone||"").trim()}|${(m.note||"").trim()}`;
      if(seen.has(key)) return;
      seen.add(key);

      const phoneDigits = String(m.phone||"").replace(/[^\d]/g,"");
      const wa = phoneDigits
        ? `https://wa.me/${phoneDigits}?text=${encodeURIComponent("DIGIY J√ãF ‚ôæÔ∏è ‚Äî Je suis int√©ress√© par: " + (m.title||""))}`
        : "#";

      const div = document.createElement("div");
      div.className = "mission";
      div.innerHTML = `
        <div class="m-title">${esc(m.title)}</div>
        <div class="m-meta">
          <span class="pill">üìç ${esc(m.zone || "‚Äî")}</span>
          <span class="pill">üìû ${esc(m.phone || "‚Äî")}</span>
          ${m.created_at ? `<span class="pill">üïí ${esc(new Date(m.created_at).toLocaleString("fr-FR"))}</span>` : ``}
        </div>
        ${m.note ? `<div class="m-meta">üìù ${esc(m.note)}</div>` : ""}
        <div class="m-actions">
          ${phoneDigits
            ? `<a class="btn btn-primary" href="${wa}" target="_blank" rel="noopener">WhatsApp direct</a>`
            : `<button class="btn btn-ghost" type="button" onclick="alert('Num√©ro manquant sur cette mission')">WhatsApp</button>`
          }
        </div>
      `;
      list.appendChild(div);
    });
  }

  async function load(){
    try{
      if(!supabase || typeof supabase.from !== "function"){
        toast.textContent = "Erreur: Supabase client KO";
        console.error("Supabase client invalid:", supabase);
        return;
      }

      toast.textContent = "Chargement‚Ä¶";

      const { data, error } = await supabase
        .from("jef_missions")
        .select("title,zone,phone,note,status,created_at")
        .eq("status","approved")
        .order("created_at",{ascending:false})
        .limit(200);

      if(error){
        toast.textContent = "Erreur Supabase";
        console.error(error);
        return;
      }

      cache = data || [];
      toast.textContent = "OK ‚úÖ";
      render();

    }catch(e){
      toast.textContent = "Erreur chargement";
      console.error("Load exception:", e);
    }
  }

  async function createMission(desiredStatus){
    publishError.style.display = "none";
    publishError.textContent = "";

    const title = String(f_title.value||"").trim();
    const zoneVal = String(f_zone.value||"").trim();
    const phoneVal = cleanPhone(f_phone.value);
    const noteVal  = String(f_note.value||"").trim();
    const statusVal = desiredStatus || String(f_status.value||"pending");

    if(!title){
      publishError.style.display = "block";
      publishError.textContent = "‚ö†Ô∏è Mets un titre de mission (obligatoire).";
      return false;
    }

    try{
      const payloadCtx = getCtx();
      const row = {
        title,
        zone: zoneVal || null,
        phone: phoneVal || null,
        note: noteVal || null,
        status: statusVal
      };

      // petit bonus : si tu as une colonne payload, √ßa passera, sinon ignor√© (on ne l‚Äôenvoie pas)
      // On garde l√©ger et compatible.

      const { data, error } = await supabase
        .from("jef_missions")
        .insert(row)
        .select()
        .single();

      if(error){
        publishError.style.display = "block";
        // message humain + debug utile
        publishError.innerHTML = `‚ùå Insert bloqu√©. <br/>D√©tail : <b>${esc(error.message || "Erreur")}</b>`;
        console.error("Insert error:", error);

        // tip direct si RLS
        if(String(error.message||"").toLowerCase().includes("row-level security")){
          publishError.innerHTML += `<div style="margin-top:8px">
            üîí RLS bloque l‚Äôinsertion. Solution : autoriser insert public OU passer par ton API serveur.
          </div>`;
        }
        return false;
      }

      // si √ßa vient de NDIMBAL, on nettoie
      if(payloadCtx) clearCtx();

      closeModal();
      toast.textContent = "Publi√© ‚úÖ";
      await load();
      return true;

    }catch(e){
      publishError.style.display = "block";
      publishError.textContent = "‚ùå Exception insertion (voir console).";
      console.error("Insert exception:", e);
      return false;
    }
  }

  document.getElementById("btnDraft").addEventListener("click", ()=> createMission("pending"));
  document.getElementById("btnPublish").addEventListener("click", ()=> createMission("approved"));

  q.addEventListener("input", render);
  zone.addEventListener("change", render);

  // ‚úÖ charge au d√©marrage
  load();
})();
</script>

</body>
</html>
