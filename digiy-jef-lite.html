<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY J√ãF ‚Äî Lite (DIAG)</title>
  <meta name="theme-color" content="#16a34a"/>
  <meta name="description" content="DIGIY J√ãF Lite ‚Äî diagnostic visible √† l'√©cran." />

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75); --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
    header{padding:12px;border-bottom:1px solid var(--line);background:#071f16;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .brand{font-weight:950}
    .btn-back{border:1px solid var(--line);background:transparent;color:var(--text);border-radius:12px;padding:8px 10px;font-weight:900;cursor:pointer}
    main{padding:12px;max-width:720px;margin:0 auto}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#07271c;font-weight:900;font-size:12px}
    .card{background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:var(--radius);padding:12px;margin-top:10px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;white-space:pre-wrap;word-break:break-word;color:rgba(234,255,241,.92)}
    .list{display:grid;gap:10px;margin-top:10px}
    .mission{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:12px}
    .m-title{font-weight:950}
    .m-meta{margin-top:6px;color:var(--muted);font-weight:800;font-size:12px}
    .btn{margin-top:10px;width:100%;padding:14px;border:none;border-radius:14px;background:linear-gradient(135deg,#16a34a,#22c55e);color:#052e16;font-weight:950;cursor:pointer}
  </style>
</head>

<body>
<header>
  <div class="brand">‚ôæÔ∏è DIGIY J√ãF ‚Äî Lite</div>
  <button class="btn-back" onclick="location.href='/digiy-hub-drive/'">‚Üê DRIVE</button>
</header>

<main>
  <div class="pill" id="status">Chargement‚Ä¶</div>

  <div class="card">
    <div style="font-weight:950;margin-bottom:8px;">DIAG (impossible √† ignorer)</div>
    <div id="diag" class="mono">Init‚Ä¶</div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div class="pill" id="count">0 mission</div>
      <div class="pill" id="phase">‚Äî</div>
    </div>
    <div class="list" id="list"></div>
  </div>
</main>

<script>
/* IMPORTANT: ne JAMAIS d√©clarer une variable nomm√©e "supabase" */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

const elStatus = document.getElementById("status");
const elDiag   = document.getElementById("diag");
const elPhase  = document.getElementById("phase");
const elCount  = document.getElementById("count");
const elList   = document.getElementById("list");

function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}
function logDiag(line){
  elDiag.textContent += "\n" + line;
}
function timeLabel(d){
  const diff = Math.floor((Date.now()-new Date(d))/86400000);
  if(diff<=0) return "Aujourd‚Äôhui";
  if(diff===1) return "Hier";
  return "Il y a "+diff+" j";
}

(async function boot(){
  try{
    elDiag.textContent = "";
    logDiag("1) Page OK. JS d√©marre.");
    logDiag("2) URL: " + location.href);

    // SDK check
    elPhase.textContent = "SDK";
    if(!window.supabase || !window.supabase.createClient){
      elStatus.textContent = "SDK Supabase KO";
      logDiag("‚ùå SDK Supabase absent. CDN bloqu√© / offline / adblock ?");
      return;
    }
    logDiag("‚úÖ SDK Supabase pr√©sent.");

    // create client once
    elPhase.textContent = "CLIENT";
    if(!window.digiySupabase){
      window.digiySupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      logDiag("‚úÖ Client cr√©√©: window.digiySupabase");
    }else{
      logDiag("‚úÖ Client d√©j√† pr√©sent: r√©utilisation.");
    }

    // quick fetch test to supabase REST (network)
    elPhase.textContent = "NETWORK";
    try{
      const ping = await fetch(SUPABASE_URL + "/rest/v1/", { method:"GET" });
      logDiag("‚úÖ Network ping /rest/v1/ status=" + ping.status);
    }catch(e){
      elStatus.textContent = "R√©seau KO";
      logDiag("‚ùå fetch vers Supabase impossible: " + (e?.message || e));
      return;
    }

    // query
    elPhase.textContent = "QUERY";
    elStatus.textContent = "Chargement‚Ä¶";
    logDiag("3) Requ√™te: jef_missions WHERE status=approved ORDER created_at desc LIMIT 100");

    const { data, error } = await window.digiySupabase
      .from("jef_missions")
      .select("title,zone,phone,created_at,status")
      .eq("status","approved")
      .order("created_at",{ascending:false})
      .limit(100);

    if(error){
      elStatus.textContent = "Erreur Supabase";
      logDiag("‚ùå Supabase error.code=" + (error.code || "‚Äî"));
      logDiag("‚ùå Supabase error.message=" + (error.message || "‚Äî"));
      logDiag("‚ùå Supabase error.details=" + (error.details || "‚Äî"));
      logDiag("‚ùå Supabase error.hint=" + (error.hint || "‚Äî"));
      elList.innerHTML = `<div class="mission"><div class="m-title">Erreur Supabase</div><div class="m-meta">${esc(error.message || "")}</div></div>`;
      return;
    }

    const items = data || [];
    elStatus.textContent = "OK";
    elCount.textContent = items.length + (items.length>1 ? " missions" : " mission");
    logDiag("‚úÖ Data re√ßue: " + items.length + " ligne(s).");

    if(!items.length){
      elList.innerHTML = `<div class="mission"><div class="m-title">Aucune mission approved</div><div class="m-meta">Soit la table est vide, soit le status n‚Äôest pas 'approved', soit RLS filtre.</div></div>`;
      return;
    }

    // render minimal
    elList.innerHTML = "";
    items.forEach(m=>{
      const div = document.createElement("div");
      div.className = "mission";
      div.innerHTML = `
        <div class="m-title">${esc(m.title)}</div>
        <div class="m-meta">üìç ${esc(m.zone||"‚Äî")} ‚Ä¢ üïí ${esc(timeLabel(m.created_at))}</div>
        <button class="btn">üìû Contacter</button>
      `;
      div.querySelector(".btn").onclick = ()=>{
        const phone = String(m.phone||"").replace(/[^\d+]/g,"");
        if(!phone){ alert("Num√©ro indisponible."); return; }
        if(confirm("Appeler ce num√©ro ?")){
          location.href = "tel:" + phone;
        }
      };
      elList.appendChild(div);
    });

  }catch(e){
    elStatus.textContent = "Erreur JS";
    logDiag("üí• Exception JS: " + (e?.message || e));
  }finally{
    elPhase.textContent = "FIN";
    logDiag("‚Äî FIN DIAG ‚Äî");
  }
})();
</script>

</body>
</html>

