<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY J√ãF ‚Äî Admin Validation</title>
  <meta name="theme-color" content="#16a34a"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --green:#16a34a; --green2:#22c55e;
      --bg:#061b14;
      --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.12);
      --text:#eafff1;
      --muted:rgba(234,255,241,.75);
      --dark:#052e16;
      --radius:18px;
      --gold:#facc15;
      --danger:#ef4444;
      --ok:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(34,197,94,.25), transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:100;
      background:rgba(6,27,20,.88);
      backdrop-filter:blur(12px);
      border-bottom:1px solid var(--line);
      padding:14px;
      box-shadow:0 2px 12px rgba(0,0,0,.3);
    }
    .top{
      max-width:1100px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .brand{
      font-weight:950; 
      letter-spacing:.08em;
      font-size:17px;
    }
    .brand small{
      display:block; 
      font-weight:850; 
      letter-spacing:0; 
      opacity:.85; 
      margin-top:3px;
      font-size:11px;
    }
    .btn{
      border:none; 
      border-radius:14px; 
      padding:11px 14px;
      font-weight:950; 
      cursor:pointer;
      font-size:13px;
      transition:all .2s;
    }
    .btn:hover:not(:disabled){
      transform:translateY(-2px);
    }
    .btn:active:not(:disabled){
      transform:translateY(0);
    }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .btn-ghost{
      background:rgba(255,255,255,.06);
      color:var(--text);
      border:1px solid var(--line);
    }
    .btn-primary{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:var(--dark);
      box-shadow:0 2px 8px rgba(34,197,94,.3);
    }
    .btn-warn{
      background:linear-gradient(135deg,#facc15,#fb923c);
      color:#111827;
      box-shadow:0 2px 8px rgba(251,191,36,.3);
    }
    .btn-danger{
      background:linear-gradient(135deg,#ef4444,#f97316);
      color:#fff;
      box-shadow:0 2px 8px rgba(239,68,68,.3);
    }
    main{
      max-width:1100px; 
      margin:0 auto; 
      padding:14px;
      padding-bottom:80px;
    }
    .grid{
      display:grid; 
      grid-template-columns:1.2fr .8fr; 
      gap:14px;
    }
    @media(max-width:900px){ 
      .grid{grid-template-columns:1fr} 
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:0 18px 40px rgba(0,0,0,.18);
    }
    .row{
      display:flex; 
      align-items:center; 
      justify-content:space-between;
      gap:10px; 
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; 
      align-items:center; 
      gap:6px;
      padding:7px 11px; 
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.14);
      font-weight:900; 
      font-size:12px;
    }
    .pill.status-ok{
      background:rgba(34,197,94,.15);
      border-color:rgba(34,197,94,.3);
      color:#86efac;
    }
    .pill.status-warn{
      background:rgba(251,191,36,.15);
      border-color:rgba(251,191,36,.3);
      color:#fcd34d;
    }
    .pill.status-error{
      background:rgba(239,68,68,.15);
      border-color:rgba(239,68,68,.3);
      color:#fca5a5;
    }
    .pill.status-pending{
      background:rgba(147,197,253,.15);
      border-color:rgba(147,197,253,.3);
      color:#93c5fd;
    }

    /* Stats */
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(130px, 1fr));
      gap:10px;
      margin-top:12px;
    }
    .stat-card{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      text-align:center;
    }
    .stat-value{
      font-weight:950;
      font-size:24px;
      color:var(--green2);
    }
    .stat-label{
      font-weight:800;
      font-size:10px;
      color:var(--muted);
      margin-top:4px;
      text-transform:uppercase;
      letter-spacing:.05em;
    }

    .muted{
      color:var(--muted); 
      font-weight:850;
      line-height:1.4;
    }
    .list{
      display:grid; 
      gap:12px; 
      margin-top:14px;
    }
    .mission{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:14px;
      transition:all .2s;
    }
    .mission:hover{
      background:rgba(255,255,255,.08);
      border-color:rgba(34,197,94,.2);
    }
    .mission-header{
      display:flex;
      justify-content:space-between;
      align-items:start;
      gap:10px;
    }
    .m-title{
      font-weight:950; 
      font-size:16px;
      line-height:1.3;
      flex:1;
    }
    .m-badge{
      padding:5px 9px;
      border-radius:8px;
      font-weight:950;
      font-size:10px;
      white-space:nowrap;
    }
    .m-badge.new{
      background:rgba(34,197,94,.15);
      color:#86efac;
    }
    .m-badge.old{
      background:rgba(251,191,36,.15);
      color:#fcd34d;
    }
    .m-meta{
      margin-top:10px; 
      display:flex; 
      gap:10px; 
      flex-wrap:wrap;
      color:var(--muted); 
      font-weight:850; 
      font-size:12px;
    }
    .m-note{
      margin-top:10px;
      padding:10px;
      background:rgba(0,0,0,.15);
      border-radius:10px;
      color:rgba(234,255,241,.88);
      font-weight:850;
      line-height:1.4;
      font-size:12px;
    }
    .actions{
      margin-top:12px; 
      display:flex; 
      gap:10px; 
      flex-wrap:wrap;
    }
    .actions .btn{
      flex:1;
      min-width:100px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    a{
      color:#86efac; 
      text-decoration:none; 
      font-weight:950;
    }

    input,select{
      width:100%; 
      padding:12px; 
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text); 
      outline:none; 
      font-weight:850;
      font-size:14px;
      transition:border-color .2s;
    }
    input:focus,select:focus{
      border-color:var(--green);
    }

    .dangerBox{
      display:none;
      margin-top:12px;
      background:rgba(239,68,68,.12);
      border:1px solid rgba(239,68,68,.25);
      border-radius:14px;
      padding:12px;
      color:rgba(255,230,230,.95);
      font-weight:900;
      line-height:1.4;
      font-size:13px;
    }
    .okBox{
      display:none;
      margin-top:12px;
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.25);
      border-radius:14px;
      padding:12px;
      color:rgba(134,239,172,.95);
      font-weight:900;
      font-size:13px;
    }

    .empty{
      text-align:center;
      padding:40px 20px;
      color:var(--muted);
      font-weight:900;
    }
    .empty-icon{
      font-size:48px;
      opacity:.5;
      margin-bottom:12px;
    }

    .info-panel{
      background:rgba(236,253,245,.08);
      border:1px solid rgba(187,247,208,.2);
      border-radius:14px;
      padding:12px;
      margin-top:12px;
    }
    .info-panel strong{
      color:#86efac;
    }

    .quick-actions{
      margin-top:12px;
      display:grid;
      gap:10px;
    }

    .realtime-indicator{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(34,197,94,.15);
      border:1px solid rgba(34,197,94,.3);
      font-size:11px;
      font-weight:900;
      color:#86efac;
      margin-top:10px;
    }
    .realtime-indicator::before{
      content:"";
      width:8px;
      height:8px;
      border-radius:50%;
      background:#22c55e;
      animation:pulse-dot 2s infinite;
    }
    @keyframes pulse-dot{
      0%,100%{opacity:1}
      50%{opacity:.5}
    }

    /* Skeleton */
    .skeleton{
      background:linear-gradient(90deg,rgba(255,255,255,.05) 25%,rgba(255,255,255,.1) 50%,rgba(255,255,255,.05) 75%);
      background-size:200% 100%;
      animation:shimmer 1.5s infinite;
      border-radius:8px;
      height:20px;
      margin:8px 0;
    }
    @keyframes shimmer{
      0%{background-position:200% 0}
      100%{background-position:-200% 0}
    }

    /* Bulk Actions */
    .bulk-actions{
      margin-top:12px;
      padding:12px;
      background:rgba(251,191,36,.08);
      border:1px solid rgba(251,191,36,.2);
      border-radius:14px;
      display:none;
    }
    .bulk-actions.active{
      display:block;
    }
    .bulk-actions-title{
      font-weight:950;
      font-size:14px;
      margin-bottom:10px;
      color:#fcd34d;
    }
    .bulk-actions-btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand">‚ôæÔ∏è DIGIY J√ãF ‚Äî ADMIN
      <small>Validation missions ‚Ä¢ pending ‚Üí approved ‚Ä¢ contr√¥le qualit√©</small>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
      <button class="btn btn-ghost" id="btn-public" type="button">üëÅÔ∏è Vue publique</button>
      <button class="btn btn-ghost" id="btn-hub" type="button">‚Üê HUB</button>
      <button class="btn btn-primary" id="btn-refresh" type="button">üîÑ Refresh</button>
      <button class="btn btn-warn" id="btn-logout" type="button">üö™ D√©connexion</button>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- LISTE -->
    <div class="card">
      <div class="row">
        <div>
          <div style="font-weight:950;font-size:16px">üîç Missions en attente de validation</div>
          <div class="muted" style="margin-top:4px;font-size:12px">
            Valide en 1 clic. Seules les missions "approved" sont visibles publiquement.
          </div>
        </div>
        <div class="pill status-pending" id="countPill">
          <span>üìã</span>
          <span id="countText">0</span>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-grid" id="statsGrid" style="display:none">
        <div class="stat-card">
          <div class="stat-value" id="statPending">0</div>
          <div class="stat-label">En attente</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statToday">0</div>
          <div class="stat-label">Aujourd'hui</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statOld">0</div>
          <div class="stat-label">+3 jours</div>
        </div>
      </div>

      <!-- Filtres -->
      <div style="margin-top:12px" class="row">
        <input id="q" placeholder="üîç Filtrer: mot-cl√© (titre, note, t√©l√©phone)‚Ä¶" style="max-width:520px">
        <select id="zone" style="max-width:220px">
          <option value="">üìç Toutes zones</option>
          <option value="Saly">Saly</option>
          <option value="Dakar">Dakar</option>
          <option value="Mbour">Mbour</option>
          <option value="Thi√®s">Thi√®s</option>
          <option value="Autre">Autre</option>
        </select>
      </div>

      <!-- Bulk Actions -->
      <div class="bulk-actions" id="bulkActions">
        <div class="bulk-actions-title">‚ö° Actions group√©es (<span id="bulkCount">0</span> s√©lectionn√©es)</div>
        <div class="bulk-actions-btns">
          <button class="btn btn-primary" id="bulkApprove">‚úÖ Tout approuver</button>
          <button class="btn btn-warn" id="bulkReject">üü† Tout rejeter</button>
          <button class="btn btn-ghost" id="bulkClear">‚úï D√©s√©lectionner</button>
        </div>
      </div>

      <div class="dangerBox" id="errBox"></div>
      <div class="okBox" id="okBox"></div>

      <div class="list" id="list">
        <!-- Skeleton -->
        <div class="mission">
          <div class="skeleton" style="width:70%"></div>
          <div class="skeleton" style="width:50%;height:14px"></div>
        </div>
        <div class="mission">
          <div class="skeleton" style="width:65%"></div>
          <div class="skeleton" style="width:55%;height:14px"></div>
        </div>
      </div>
    </div>

    <!-- INFO / STATUS -->
    <div class="card">
      <div class="row">
        <div style="font-weight:950;font-size:16px">üìä Statut admin</div>
        <div class="pill status-warn" id="adminPill">
          <span>‚è≥</span>
          <span>V√©rification‚Ä¶</span>
        </div>
      </div>

      <div class="realtime-indicator" id="realtimeIndicator" style="display:none">
        <span>Temps r√©el activ√©</span>
      </div>

      <div class="info-panel">
        <div style="font-weight:900;font-size:13px;margin-bottom:8px">‚ÑπÔ∏è Guide rapide</div>
        <div style="font-size:12px;line-height:1.5">
          <strong>‚úÖ Approve</strong> ‚Üí Mission visible publiquement<br/>
          <strong>üü† Reject</strong> ‚Üí Cach√©e (reste en base)<br/>
          <strong>üóëÔ∏è Delete</strong> ‚Üí Supprim√©e d√©finitivement<br/><br/>
          üí° <strong>Workflow</strong> : Public publie en "pending", admin valide avant publication.
        </div>
      </div>

      <div style="margin-top:12px;font-weight:900;font-size:13px">üîó Liens rapides</div>
      <div class="quick-actions">
        <a class="btn btn-primary" href="digiy-jef.html">üëÅÔ∏è Ouvrir J√ãF (public)</a>
        <button class="btn btn-ghost" id="openSupabase">üìä Table Supabase</button>
        <button class="btn btn-ghost" id="openApproved">‚úÖ Voir approuv√©es</button>
        <button class="btn btn-ghost" id="openRejected">üü† Voir rejet√©es</button>
      </div>

      <!-- User Info -->
      <div id="userInfo" style="margin-top:14px;padding:10px;background:rgba(0,0,0,.15);border-radius:10px;font-size:11px;display:none">
        <div style="font-weight:900;margin-bottom:4px">üë§ Connect√© en tant que:</div>
        <div id="userEmail" style="color:var(--muted);font-weight:800"></div>
      </div>
    </div>
  </div>
</main>

<script>
/* ======================================================
   SUPABASE INIT
====================================================== */
(function initSupabaseOnce(){
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  if (!window.supabase || !window.supabase.createClient) {
    alert("‚ùå Supabase SDK introuvable (CDN).");
    return;
  }
  if (!window.digiySupabase) {
    window.digiySupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }
})();

(function(){
  const supabase = window.digiySupabase;

  // DOM
  const list = document.getElementById("list");
  const q = document.getElementById("q");
  const zone = document.getElementById("zone");
  const countText = document.getElementById("countText");
  const adminPill = document.getElementById("adminPill");
  const errBox = document.getElementById("errBox");
  const okBox = document.getElementById("okBox");
  const statsGrid = document.getElementById("statsGrid");
  const statPending = document.getElementById("statPending");
  const statToday = document.getElementById("statToday");
  const statOld = document.getElementById("statOld");
  const realtimeIndicator = document.getElementById("realtimeIndicator");
  const userInfo = document.getElementById("userInfo");
  const userEmail = document.getElementById("userEmail");

  // Navigation
  const basePath = location.pathname.includes("/digiy-hub/") ? "/digiy-hub/" : "/";
  document.getElementById("btn-hub").onclick = ()=> location.href = basePath;
  document.getElementById("btn-public").onclick = ()=> location.href = "digiy-jef.html";
  document.getElementById("btn-refresh").onclick = ()=> load();
  document.getElementById("btn-logout").onclick = async ()=>{
    try{ await supabase.auth.signOut(); }catch(e){}
    location.reload();
  };

  document.getElementById("openSupabase").onclick = ()=>{
    alert("üí° Va sur Supabase ‚Üí Table Editor ‚Üí public.jef_missions\n(Tu es d√©j√† admin)");
  };

  document.getElementById("openApproved").onclick = async ()=>{
    const { data } = await supabase
      .from("jef_missions")
      .select("count", { count: 'exact', head: true })
      .eq("status","approved");
    alert(`‚úÖ Missions approuv√©es: ${data || '?'}`);
  };

  document.getElementById("openRejected").onclick = async ()=>{
    const { data } = await supabase
      .from("jef_missions")
      .select("count", { count: 'exact', head: true })
      .eq("status","rejected");
    alert(`üü† Missions rejet√©es: ${data || '?'}`);
  };

  // State
  let cache = [];
  let channel = null;
  let selectedIds = new Set();

  // Utils
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[m]));
  }
  function norm(s){ return (s||"").toLowerCase(); }
  function isNew(d){ return new Date(d) > Date.now() - 86400000; }
  function isOld(d){ return new Date(d) < Date.now() - 259200000; } // 3 days
  function timeLabel(d){
    const diff = Math.floor((Date.now() - new Date(d).getTime())/86400000);
    if(diff <= 0) return "Aujourd'hui";
    if(diff === 1) return "Hier";
    if(diff < 7) return `Il y a ${diff}j`;
    return `Il y a ${Math.floor(diff/7)}sem`;
  }

  function updateStatus(type, text){
    adminPill.className = "pill status-" + type;
    adminPill.innerHTML = `
      <span>${type === "ok" ? "‚úÖ" : type === "error" ? "‚ùå" : type === "warn" ? "‚ö†Ô∏è" : "‚è≥"}</span>
      <span>${esc(text)}</span>
    `;
  }

  function showErr(msg){
    errBox.style.display = "block";
    errBox.innerHTML = msg;
    okBox.style.display = "none";
  }

  function showOk(msg){
    okBox.style.display = "block";
    okBox.textContent = msg;
    errBox.style.display = "none";
    setTimeout(()=>{ okBox.style.display="none"; }, 2000);
  }

  function updateStats(){
    const today = cache.filter(m => isNew(m.created_at)).length;
    const old = cache.filter(m => isOld(m.created_at)).length;
    
    statPending.textContent = cache.length;
    statToday.textContent = today;
    statOld.textContent = old;
    
    if(cache.length > 0){
      statsGrid.style.display = "grid";
    }
  }

  function updateBulkActions(){
    const bulkActions = document.getElementById("bulkActions");
    const bulkCount = document.getElementById("bulkCount");
    bulkCount.textContent = selectedIds.size;
    bulkActions.classList.toggle("active", selectedIds.size > 0);
  }

  async function adminGuard(){
    updateStatus("warn", "V√©rification‚Ä¶");

    const { data: { user }, error: e0 } = await supabase.auth.getUser();
    if(e0) console.error(e0);
    
    if(!user){
      updateStatus("error", "Non connect√©");
      showErr("üîê Tu n'es pas connect√©. Ouvre ton HUB, connecte-toi, puis reviens ici.");
      return false;
    }

    // Display user info
    userInfo.style.display = "block";
    userEmail.textContent = user.email || user.id;

    const { data, error } = await supabase
      .from("admin_users")
      .select("user_id")
      .eq("user_id", user.id)
      .maybeSingle();

    if(error){
      console.error(error);
      showErr("‚ùå Erreur admin check: " + esc(error.message||""));
      updateStatus("error", "Erreur");
      return false;
    }

    if(!data){
      updateStatus("error", "Acc√®s refus√©");
      showErr("‚õî Acc√®s refus√©. Ton user n'est pas dans <b>admin_users</b>.");
      return false;
    }

    updateStatus("ok", "ADMIN");
    return true;
  }

  function render(){
    const qq = norm(q.value);
    const zz = zone.value;

    const filtered = cache.filter(m=>{
      const blob = `${m.title||""} ${m.note||""} ${m.phone||""} ${m.zone||""}`;
      const okQ = !qq || norm(blob).includes(qq);
      const okZ = !zz || m.zone === zz;
      return okQ && okZ;
    });

    countText.textContent = filtered.length + " pending";
    list.innerHTML = "";

    if(!filtered.length){
      list.innerHTML = `
        <div class="empty">
          <div class="empty-icon">‚úÖ</div>
          <div>${qq || zz ? "Aucune mission trouv√©e pour ces crit√®res" : "Aucune mission en attente"}</div>
          <div style="font-size:12px;margin-top:8px;opacity:.8">Tout est valid√© ‚ôæÔ∏è</div>
        </div>
      `;
      return;
    }

    filtered.forEach(m=>{
      const phoneDigits = String(m.phone||"").replace(/[^\d]/g,"");
      const waMsg = encodeURIComponent(`DIGIY J√ãF ‚ôæÔ∏è ‚Äî Concernant: ${m.title}`);
      const waLink = phoneDigits ? `https://wa.me/${phoneDigits}?text=${waMsg}` : "#";
      const isNewMission = isNew(m.created_at);
      const isOldMission = isOld(m.created_at);

      const div = document.createElement("div");
      div.className = "mission";
      div.innerHTML = `
        <div class="mission-header">
          <div style="display:flex;align-items:center;gap:10px;flex:1">
            <input type="checkbox" class="mission-checkbox" data-id="${esc(m.id)}" style="width:18px;height:18px;cursor:pointer" ${selectedIds.has(m.id) ? 'checked' : ''}>
            <div class="m-title">${esc(m.title)}</div>
          </div>
          ${isNewMission ? '<div class="m-badge new">NEW</div>' : ''}
          ${isOldMission ? '<div class="m-badge old">ANCIEN</div>' : ''}
        </div>
        <div class="m-meta">
          <span class="pill">üìç ${esc(m.zone || "Zone non pr√©cis√©e")}</span>
          <span class="pill">üìû ${esc(m.phone || "‚Äî")}</span>
          <span class="pill">üïí ${esc(timeLabel(m.created_at))}</span>
          <span class="pill status-pending">‚è≥ pending</span>
        </div>
        ${m.note ? `<div class="m-note">üìù ${esc(m.note)}</div>` : ""}
        <div class="actions">
          <button class="btn btn-primary" data-act="approve" data-id="${esc(m.id)}">‚úÖ Approve</button>
          <button class="btn btn-warn" data-act="reject" data-id="${esc(m.id)}">üü† Reject</button>
          <button class="btn btn-danger" data-act="delete" data-id="${esc(m.id)}">üóëÔ∏è Delete</button>
          ${phoneDigits ? `<a class="btn btn-ghost" href="${waLink}" target="_blank" rel="noopener">üí¨ WhatsApp</a>` : ``}
        </div>
      `;
      list.appendChild(div);
    });

    // Checkbox listeners
    document.querySelectorAll(".mission-checkbox").forEach(cb => {
      cb.onchange = (e) => {
        const id = e.target.dataset.id;
        if(e.target.checked){
          selectedIds.add(id);
        } else {
          selectedIds.delete(id);
        }
        updateBulkActions();
      };
    });
  }

  async function load(){
    try{
      const ok = await adminGuard();
      if(!ok) return;

      const { data, error } = await supabase
        .from("jef_missions")
        .select("id,title,zone,phone,note,status,created_at")
        .eq("status","pending")
        .order("created_at",{ascending:false})
        .limit(300);

      if(error){
        console.error(error);
        showErr("‚ùå Erreur load: <b>" + esc(error.message||"") + "</b>");
        return;
      }

      cache = data || [];
      updateStats();
      render();

    }catch(e){
      console.error(e);
      showErr("‚ùå Exception load (voir console).");
    }
  }

  async function approve(id){
    const { error } = await supabase
      .from("jef_missions")
      .update({ status: "approved" })
      .eq("id", id);
    if(error) throw error;
  }

  async function reject(id){
    const { error } = await supabase
      .from("jef_missions")
      .update({ status: "rejected" })
      .eq("id", id);
    if(error) throw error;
  }

  async function del(id){
    const { error } = await supabase
      .from("jef_missions")
      .delete()
      .eq("id", id);
    if(error) throw error;
  }

  // Action handlers
  list.addEventListener("click", async (e)=>{
    const btn = e.target.closest("button[data-act]");
    if(!btn) return;

    const act = btn.getAttribute("data-act");
    const id  = btn.getAttribute("data-id");

    try{
      btn.disabled = true;

      if(act === "approve"){
        await approve(id);
        showOk("‚úÖ Mission approuv√©e");
      }else if(act === "reject"){
        await reject(id);
        showOk("üü† Mission rejet√©e");
      }else if(act === "delete"){
        if(!confirm("‚ùì Supprimer d√©finitivement cette mission ?")) {
          btn.disabled=false;
          return;
        }
        await del(id);
        showOk("üóëÔ∏è Mission supprim√©e");
      }

      cache = cache.filter(x => x.id !== id);
      selectedIds.delete(id);
      updateStats();
      updateBulkActions();
      render();

    }catch(err){
      console.error(err);
      showErr("‚ùå Action refus√©e: <b>" + esc(err.message||"Erreur") + "</b>");
      btn.disabled = false;
    }
  });

  // Bulk actions
  document.getElementById("bulkApprove").onclick = async () => {
    if(!confirm(`‚úÖ Approuver ${selectedIds.size} missions ?`)) return;
    
    try{
      for(const id of selectedIds){
        await approve(id);
      }
      showOk(`‚úÖ ${selectedIds.size} missions approuv√©es`);
      cache = cache.filter(x => !selectedIds.has(x.id));
      selectedIds.clear();
      updateStats();
      updateBulkActions();
      render();
    }catch(e){
      showErr("‚ùå Erreur bulk approve: " + esc(e.message));
    }
  };

  document.getElementById("bulkReject").onclick = async () => {
    if(!confirm(`üü† Rejeter ${selectedIds.size} missions ?`)) return;
    
    try{
      for(const id of selectedIds){
        await reject(id);
      }
      showOk(`üü† ${selectedIds.size} missions rejet√©es`);
      cache = cache.filter(x => !selectedIds.has(x.id));
      selectedIds.clear();
      updateStats();
      updateBulkActions();
      render();
    }catch(e){
      showErr("‚ùå Erreur bulk reject: " + esc(e.message));
    }
  };

  document.getElementById("bulkClear").onclick = () => {
    selectedIds.clear();
    updateBulkActions();
    render();
  };

  // Filters
  q.oninput = render;
  zone.onchange = render;

  // Realtime
  function setupRealtime(){
    try{
      if(channel) return;
      channel = supabase
        .channel("jef_admin_realtime")
        .on("postgres_changes",
          { event: "*", schema: "public", table: "jef_missions" },
          () => {
            console.log("üîÑ Realtime update detected");
            load();
          }
        )
        .subscribe((status) => {
          if(status === 'SUBSCRIBED'){
            realtimeIndicator.style.display = "inline-flex";
          }
        });
    }catch(e){
      console.warn("‚ö†Ô∏è Realtime not available:", e);
    }
  }

  // Init
  load();
  setupRealtime();
})();
</script>

</body>
</html>
