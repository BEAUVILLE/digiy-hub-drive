<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY ‚ôæÔ∏è J√ãF ‚Äî Admin missions</title>
  <meta name="theme-color" content="#16a34a"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --green:#16a34a; --green2:#22c55e;
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.78); --dark:#052e16;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background: radial-gradient(900px 500px at 10% -10%, rgba(34,197,94,.20), transparent 60%), var(--bg);
      color:var(--text);
    }
    header{
      padding:16px;
      border-bottom:1px solid var(--line);
      background:rgba(6,27,20,.72);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{font-weight:950; letter-spacing:.1em}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      border:none; cursor:pointer;
      border-radius:999px;
      padding:10px 12px;
      font-weight:950;
    }
    .btn.primary{background:linear-gradient(135deg,var(--green),var(--green2)); color:var(--dark)}
    .btn.ghost{background:rgba(255,255,255,.06); border:1px solid var(--line); color:var(--text)}
    main{max-width:900px; margin:0 auto; padding:14px; display:flex; flex-direction:column; gap:12px;}
    .card{background:rgba(255,255,255,.06); border:1px solid var(--line); border-radius:var(--radius); padding:14px;}
    .muted{color:var(--muted); font-weight:800; font-size:13px}
    .grid{display:grid; gap:10px}
    .mission{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
    }
    .topline{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap}
    .title{font-weight:950; font-size:16px}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      font-weight:950; font-size:12px;
    }
    .meta{margin-top:6px; display:flex; flex-wrap:wrap; gap:8px; font-weight:850; font-size:13px; color:var(--muted)}
    .actions{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap}
    .btn.approve{background:linear-gradient(135deg,#16a34a,#22c55e); color:var(--dark)}
    .btn.reject{background:linear-gradient(135deg,#ef4444,#b91c1c); color:#fee2e2}
    .btn.small{padding:10px 12px; border-radius:14px}
    input{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#052e16;
      color:var(--text);
      font-size:14px;
      font-weight:800;
      outline:none;
    }
    footer{
      text-align:center;
      padding:14px 10px;
      font-size:12px;
      font-weight:800;
      color:rgba(234,255,241,.72);
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(6,27,20,.55);
    }
    a{color:#86efac; text-decoration:none; font-weight:950}
    .hide{display:none}
  </style>
</head>

<body>

<header>
  <div class="row">
    <div class="brand">‚ôæÔ∏è DIGIY J√ãF ‚Äî ADMIN</div>
    <span class="pill" id="adminPill">‚Äî</span>
  </div>
  <div class="row">
    <button class="btn ghost" id="btnBackHub" type="button">‚Üê Retour HUB</button>
    <button class="btn ghost" id="btnReload" type="button">‚Üª Rafra√Æchir</button>
    <button class="btn primary" id="btnLogin" type="button">üîê Se connecter</button>
    <button class="btn ghost hide" id="btnLogout" type="button">‚èè D√©connexion</button>
  </div>
</header>

<main>

  <div class="card">
    <div style="font-weight:950;margin-bottom:6px;">Validation des missions</div>
    <div class="muted">Les missions arrivent en <b>pending</b>. Toi tu <b>valides</b> ou tu <b>refuses</b>.</div>
  </div>

  <div class="card" id="loginCard">
    <div style="font-weight:950;margin-bottom:10px;">Connexion admin</div>
    <div class="muted" style="margin-bottom:10px;">Entre ton email/mot de passe Supabase (Auth) pour acc√©der aux boutons.</div>
    <div class="grid">
      <input id="email" type="email" placeholder="Email admin"/>
      <input id="password" type="password" placeholder="Mot de passe"/>
      <button class="btn primary" id="btnDoLogin" type="button">Se connecter</button>
      <div class="muted" id="loginStatus">‚Äî</div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <div style="font-weight:950;">Missions en attente</div>
        <div class="muted" id="countPending">‚Äî</div>
      </div>
      <div class="row">
        <button class="btn ghost" id="btnShowPending" type="button">Pending</button>
        <button class="btn ghost" id="btnShowApproved" type="button">Approved</button>
        <button class="btn ghost" id="btnShowRejected" type="button">Rejected</button>
      </div>
    </div>
  </div>

  <div id="list" class="grid"></div>

</main>

<footer>
  DIGIYLYFE ‚ôæÔ∏è ‚Äî direct au peuple ‚Ä¢ 0% commission ‚Ä¢
  <a href="https://beauville.github.io/digiy-hub-drive/">Retour HUB</a>
</footer>

<script>
/* =========================
   SUPABASE (TON PROJET)
========================= */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

const SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   UI refs
========================= */
const listEl = document.getElementById("list");
const countPending = document.getElementById("countPending");
const adminPill = document.getElementById("adminPill");

const loginCard = document.getElementById("loginCard");
const loginStatus = document.getElementById("loginStatus");
const btnLogin = document.getElementById("btnLogin");
const btnLogout = document.getElementById("btnLogout");
const btnDoLogin = document.getElementById("btnDoLogin");

const btnReload = document.getElementById("btnReload");
const btnBackHub = document.getElementById("btnBackHub");

const btnShowPending = document.getElementById("btnShowPending");
const btnShowApproved = document.getElementById("btnShowApproved");
const btnShowRejected = document.getElementById("btnShowRejected");

let currentFilter = "pending";

function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function setStatusPill(text){
  adminPill.textContent = text;
}

function setLoginUI(isAuthed){
  btnLogout.classList.toggle("hide", !isAuthed);
  loginCard.classList.toggle("hide", isAuthed);
}

async function isAdmin(){
  const { data: { user } } = await SB.auth.getUser();
  if(!user) return { ok:false, user:null };

  const { data, error } = await SB
    .from("admin_users")
    .select("user_id")
    .eq("user_id", user.id)
    .maybeSingle();

  if(error || !data) return { ok:false, user };
  return { ok:true, user };
}

async function loadCountPending(){
  const { count, error } = await SB
    .from("jef_missions")
    .select("id", { count: "exact", head: true })
    .eq("status", "pending");

  if(error) { countPending.textContent = "Erreur"; return; }
  countPending.textContent = `${count ?? 0} mission(s)`;
}

function render(rows, adminOk, user){
  listEl.innerHTML = "";
  if(!rows || rows.length === 0){
    listEl.innerHTML = `<div class="card"><div class="muted">Aucune mission.</div></div>`;
    return;
  }

  rows.forEach(r=>{
    const whenTxt = r.when_time ? `‚è∞ ${esc(r.when_time)}` : "";
    const detTxt  = r.details ? esc(r.details) : "‚Äî";

    const div = document.createElement("div");
    div.className = "mission";

    div.innerHTML = `
      <div class="topline">
        <div class="title">üìù ${esc(r.title)}</div>
        <span class="pill">üìå ${esc(r.status)}</span>
      </div>

      <div class="meta">
        <span>üìç ${esc(r.zone || "‚Äî")}</span>
        ${whenTxt ? `<span>${whenTxt}</span>` : ""}
        <span>üìû ${esc(r.phone || "‚Äî")}</span>
      </div>

      <div class="muted" style="margin-top:8px;line-height:1.45">
        ${detTxt}
      </div>

      <div class="actions">
        <button class="btn small ghost" type="button"
          onclick="window.open('https://wa.me/${String(r.phone||"").replace(/\D/g,"")}?text=${encodeURIComponent("Salam, j'ai vu ta mission DIGIY J√ãF : "+(r.title||""))}','_blank')">
          üí¨ WhatsApp
        </button>

        ${adminOk ? `
          <button class="btn small approve" type="button" onclick="approve('${r.id}')">‚úÖ Valider</button>
          <button class="btn small reject" type="button" onclick="reject('${r.id}')">‚õî Refuser</button>
        ` : `
          <span class="pill">üîí Admin requis</span>
        `}
      </div>
    `;

    listEl.appendChild(div);
  });
}

async function loadMissions(){
  const admin = await isAdmin();
  setLoginUI(!!admin.user);

  if(!admin.user){
    setStatusPill("Non connect√©");
  }else{
    setStatusPill(admin.ok ? "ADMIN OK ‚úÖ" : "Connect√© (non-admin)");
  }

  // ‚úÖ CORRIG√â : when ‚Üí when_time
  const { data, error } = await SB
    .from("jef_missions")
    .select("id,created_at,title,zone,phone,when_time,details,status,approved_at,approved_by")
    .eq("status", currentFilter)
    .order("created_at", { ascending:false })
    .limit(100);

  if(error){
    listEl.innerHTML = `<div class="card"><div class="muted">Erreur chargement : ${esc(error.message)}</div></div>`;
    return;
  }

  await loadCountPending();
  render(data || [], admin.ok, admin.user);
}

async function approve(id){
  const admin = await isAdmin();
  if(!admin.ok) return alert("Admin requis. Connecte-toi.");

  const ok = confirm("Valider cette mission ? Elle sera publique.");
  if(!ok) return;

  const { error } = await SB.from("jef_missions")
    .update({
      status:"approved",
      approved_at: new Date().toISOString(),
      approved_by: admin.user.id
    })
    .eq("id", id);

  if(error) return alert("Erreur: " + error.message);
  await loadMissions();
}

async function reject(id){
  const admin = await isAdmin();
  if(!admin.ok) return alert("Admin requis. Connecte-toi.");

  const ok = confirm("Refuser cette mission ?");
  if(!ok) return;

  const { error } = await SB.from("jef_missions")
    .update({
      status:"rejected",
      approved_at: null,
      approved_by: admin.user.id
    })
    .eq("id", id);

  if(error) return alert("Erreur: " + error.message);
  await loadMissions();
}

async function doLogin(){
  loginStatus.textContent = "Connexion‚Ä¶";
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;

  const { error } = await SB.auth.signInWithPassword({ email, password });
  if(error){
    loginStatus.textContent = "‚ùå " + error.message;
    return;
  }
  loginStatus.textContent = "‚úÖ Connect√©";
  await loadMissions();
}

async function doLogout(){
  await SB.auth.signOut();
  await loadMissions();
}

/* UI events */
btnDoLogin.addEventListener("click", doLogin);
btnLogin.addEventListener("click", ()=>{ window.scrollTo({top:0,behavior:"smooth"}); });
btnLogout.addEventListener("click", doLogout);

btnReload.addEventListener("click", loadMissions);
btnBackHub.addEventListener("click", ()=> window.location.href="https://beauville.github.io/digiy-hub-drive/");

btnShowPending.addEventListener("click", ()=>{ currentFilter="pending"; loadMissions(); });
btnShowApproved.addEventListener("click", ()=>{ currentFilter="approved"; loadMissions(); });
btnShowRejected.addEventListener("click", ()=>{ currentFilter="rejected"; loadMissions(); });

/* Start */
loadMissions();
</script>

</body>
</html>
