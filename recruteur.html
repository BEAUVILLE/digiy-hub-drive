<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>DIGIY J√ãF ‚àû ‚Äî Recruteur (Je cherche apprenti)</title>
  <meta name="theme-color" content="#071a12" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#020617;
      --bg2:#071a12;
      --card:rgba(255,255,255,.04);
      --line:rgba(148,163,184,.22);
      --ink:#f9fafb;
      --muted:rgba(226,232,240,.78);
      --green:#22c55e;
      --gold:#facc15;
      --bad:#ef4444;
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 12% -10%, rgba(250,204,21,.14), transparent 60%),
        radial-gradient(900px 520px at 90% 0%, rgba(34,197,94,.16), transparent 60%),
        linear-gradient(180deg,var(--bg2),var(--bg));
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px}

    .top{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:22px;
      padding:14px;
      box-shadow:var(--shadow);
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:46px;height:46px;border-radius:16px;
      background:linear-gradient(135deg, rgba(250,204,21,.30), rgba(34,197,94,.18));
      border:1px solid rgba(250,204,21,.28);
      box-shadow:0 0 24px rgba(250,204,21,.14);
      display:flex;align-items:center;justify-content:center;
      font-weight:1100;
    }
    h1{margin:0;font-size:1.1rem;letter-spacing:.3px;font-weight:1000}
    .sub{color:var(--muted);font-weight:900;font-size:.98rem;margin-top:2px}

    .pills{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(255,255,255,.02);
      color:var(--muted);
      font-weight:1000;
      font-size:1rem;
    }
    .pill.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10);color:#bbf7d0}
    .pill.warn{border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.10);color:#fde68a}

    .grid{display:grid;grid-template-columns:1fr 1.1fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .cardHead h2{margin:0;font-size:1.05rem;font-weight:1100}
    .cardHead small{color:var(--muted);font-weight:900;font-size:.95rem}
    .cardBody{padding:14px}

    label{display:block;margin:12px 0 6px;font-weight:1100;font-size:1.02rem}
    input, textarea, select{
      width:100%;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--ink);
      outline:none;
      font-weight:1000;
      font-size:1.05rem;
    }
    textarea{min-height:120px;resize:vertical}
    small.hint{display:block;margin-top:6px;color:var(--muted);font-weight:900;line-height:1.35;font-size:.98rem}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .row{grid-template-columns:1fr} }

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{
      border:0; cursor:pointer;
      border-radius:16px;
      padding:14px 14px;
      font-weight:1100;
      font-size:1.05rem;
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
      color:var(--ink);
      transition:.18s ease;
      min-height:52px;
    }
    .btn:hover{filter:brightness(1.06);transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:var(--green);color:#052e16;border-color:rgba(34,197,94,.35)}
    .btn.gold{background:rgba(250,204,21,.14);border-color:rgba(250,204,21,.35);color:#fde68a}
    .btn.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);color:#fecaca}
    .btn.ghost{background:rgba(255,255,255,.02)}
    .btn.small{padding:12px 12px;border-radius:14px;font-size:1rem;min-height:48px}

    .note{
      margin-top:10px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      white-space:pre-wrap;
      display:none;
      font-weight:950;
      font-size:1rem;
    }
    .note.ok{border-color:rgba(34,197,94,.35);color:#bbf7d0;background:rgba(34,197,94,.10)}
    .note.bad{border-color:rgba(239,68,68,.35);color:#fecaca;background:rgba(239,68,68,.10)}
    .note.warn{border-color:rgba(250,204,21,.35);color:#fde68a;background:rgba(250,204,21,.10)}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid rgba(148,163,184,.22);
      background:rgba(255,255,255,.02);
      border-radius:18px;
      padding:12px;
    }
    .itemTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .itemTop strong{font-weight:1200}
    .itemSub{margin-top:6px;color:var(--muted);font-weight:900;line-height:1.45}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      color:var(--muted);
      font-weight:1000;
      font-size:.98rem;
    }
    .tag.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10);color:#bbf7d0}
    .tag.gold{border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.10);color:#fde68a}

    @media (max-width:720px){
      .wrap{padding:12px}
      .btn{width:100%}
      .btnRow{flex-direction:column}
      input,textarea,select{font-size:1.07rem}
      label{font-size:1.05rem}
      .pill{font-size:1.02rem}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">üíº</div>
        <div>
          <h1>DIGIY J√ãF ‚àû ‚Äî Recruteur</h1>
          <div class="sub">Publier : ‚ÄúJe cherche apprenti‚Äù ‚Ä¢ T√©l√©phone + PIN</div>
        </div>
      </div>
      <div class="pills">
        <div class="pill" id="pillPhone">üìû <strong>‚Äî</strong></div>
        <div class="pill warn" id="pillState">üîí D√©connect√©</div>
        <button class="btn ghost small" id="btnReset" style="display:none">üîÅ Changer tel / PIN</button>
      </div>
    </div>

    <div class="grid">
      <!-- LOGIN -->
      <section class="card">
        <div class="cardHead">
          <div>
            <h2>üîë Entrer (T√©l√©phone + PIN)</h2>
            <small>Option 2 : sans SMS</small>
          </div>
        </div>
        <div class="cardBody">
          <div id="loginBox">
            <label>T√©l√©phone</label>
            <input id="iPhone" placeholder="+221 77 123 45 67" />

            <label>PIN (4 chiffres)</label>
            <input id="iPin" inputmode="numeric" placeholder="ex: 1234" maxlength="4" />

            <div class="btnRow">
              <button class="btn primary" id="btnEnter">‚úÖ Entrer</button>
              <button class="btn" id="btnDemo">‚ö° Demo</button>
            </div>

            <small class="hint">
              Le PIN reste chez toi. Si tu changes de tel : tu remets le m√™me Tel + PIN ‚Üí tu retrouves l‚Äôacc√®s.
            </small>

            <div class="note" id="loginNote"></div>
          </div>

          <div id="connectedBox" style="display:none">
            <div class="note ok" style="display:block">
              ‚úÖ Connect√©. Tu peux publier ton annonce ‚ÄúJe cherche apprenti‚Äù.
            </div>
            <div class="btnRow">
              <button class="btn danger" id="btnLogout">üö™ Se d√©connecter</button>
            </div>
          </div>
        </div>
      </section>

      <!-- PUBLISH + LIST -->
      <section class="card">
        <div class="cardHead">
          <div>
            <h2>üì£ Publier une annonce</h2>
            <small>Recruteur ‚Üí Apprenti</small>
          </div>
        </div>
        <div class="cardBody">

          <div id="publishBox" style="display:none">
            <label>Nom / Entreprise *</label>
            <input id="rName" placeholder="ex: Garage Ndiaye / Villa Saly / Boutique Awa‚Ä¶" maxlength="80" />

            <div class="row">
              <div>
                <label>Ville *</label>
                <input id="rCity" placeholder="ex: Dakar, Saly, Thi√®s..." maxlength="60" />
              </div>
              <div>
                <label>M√©tier recherch√© *</label>
                <select id="rTrade"></select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Type *</label>
                <select id="rType">
                  <option value="apprentissage">Apprentissage</option>
                  <option value="stage">Stage</option>
                  <option value="job">Job / Aide</option>
                </select>
              </div>
              <div>
                <label>Disponibilit√© *</label>
                <select id="rAvail">
                  <option value="journ√©e">Journ√©e</option>
                  <option value="soir">Soir</option>
                  <option value="weekend">Week-end</option>
                  <option value="flex">Flexible</option>
                </select>
              </div>
            </div>

            <label>Titre *</label>
            <input id="rTitle" placeholder="ex: Je cherche un apprenti √©lectricien √† Saly" maxlength="120" />

            <label>D√©tails *</label>
            <textarea id="rMsg" placeholder="D√©cris le poste : ce que tu attends, horaires, lieu, conditions‚Ä¶ (minimum 20 caract√®res)"></textarea>

            <label>Contact (WhatsApp recommand√©)</label>
            <input id="rContact" placeholder="+221 77 123 45 67" maxlength="20" />
            <small class="hint">Astuce terrain : mets le m√™me num√©ro que ton WhatsApp.</small>

            <div class="btnRow">
              <button class="btn gold" id="btnPublish">üöÄ Publier</button>
              <button class="btn" id="btnRefresh">‚Üª Actualiser la liste</button>
            </div>

            <div class="note" id="pubNote"></div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(148,163,184,.18);margin:12px 0">

          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div style="font-weight:1100;font-size:1.05rem">üßæ Annonces recruteur r√©centes</div>
            <div class="tag gold" id="countTag">‚Äî</div>
          </div>

          <div class="list" id="list" style="margin-top:10px"></div>
          <div class="note" id="listNote"></div>

        </div>
      </section>
    </div>
  </div>

<script>
/* =============================
   SUPABASE
============================= */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

function makeClient(){
  return supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    global: {
      fetch: (url, options = {}) => {
        const secret = localStorage.getItem("DIGIY_JEF_SECRET") || "";
        const headers = new Headers(options.headers || {});
        if(secret) headers.set("x-digiy-secret", secret);
        return fetch(url, { ...options, headers });
      }
    }
  });
}
let SB = makeClient();

/* =============================
   DOM
============================= */
const pillPhone = document.getElementById("pillPhone");
const pillState = document.getElementById("pillState");
const btnReset = document.getElementById("btnReset");

const loginBox = document.getElementById("loginBox");
const connectedBox = document.getElementById("connectedBox");
const publishBox = document.getElementById("publishBox");

const iPhone = document.getElementById("iPhone");
const iPin = document.getElementById("iPin");
const btnEnter = document.getElementById("btnEnter");
const btnDemo = document.getElementById("btnDemo");
const btnLogout = document.getElementById("btnLogout");
const loginNote = document.getElementById("loginNote");

const rName = document.getElementById("rName");
const rCity = document.getElementById("rCity");
const rTrade = document.getElementById("rTrade");
const rType = document.getElementById("rType");
const rAvail = document.getElementById("rAvail");
const rTitle = document.getElementById("rTitle");
const rMsg = document.getElementById("rMsg");
const rContact = document.getElementById("rContact");

const btnPublish = document.getElementById("btnPublish");
const btnRefresh = document.getElementById("btnRefresh");
const pubNote = document.getElementById("pubNote");

const list = document.getElementById("list");
const listNote = document.getElementById("listNote");
const countTag = document.getElementById("countTag");

/* =============================
   HELPERS
============================= */
const TRADES = [
  "Plomberie","√âlectricit√©","M√©canique","Vente / Boutique","M√©tier de bouche",
  "Menuiserie","Climatisation","Carrelage / Ma√ßonnerie","Peinture","Couture"
];

function showNote(el, msg, type){
  el.style.display = "block";
  el.classList.remove("ok","bad","warn");
  if(type) el.classList.add(type);
  el.textContent = msg;
}
function hideNote(el){
  el.style.display = "none";
  el.textContent = "";
  el.classList.remove("ok","bad","warn");
}
function normalizePhone(raw){
  const s = String(raw||"").replace(/\s+/g,"").trim();
  if(!s) return "";
  if(s.startsWith("+221")) return s;
  const digits = s.replace(/\D/g,"");
  if(digits.length === 9 && (digits.startsWith("7") || digits.startsWith("8") || digits.startsWith("9"))){
    return "+221" + digits;
  }
  if(digits.length === 12 && digits.startsWith("221")) return "+" + digits;
  return s.startsWith("+") ? s : ("+" + digits);
}
async function deriveSecret(phone, pin){
  const msg = `DIGIY_JEF|${phone}|${pin}|v1`;
  const enc = new TextEncoder().encode(msg);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  const hex = [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
  return hex;
}
function setConnected(on){
  if(on){
    pillState.textContent = "‚úÖ Connect√©";
    pillState.classList.remove("warn");
    pillState.classList.add("ok");
    btnReset.style.display = "inline-flex";
    loginBox.style.display = "none";
    connectedBox.style.display = "block";
    publishBox.style.display = "block";
  }else{
    pillState.textContent = "üîí D√©connect√©";
    pillState.classList.remove("ok");
    pillState.classList.add("warn");
    btnReset.style.display = "none";
    loginBox.style.display = "block";
    connectedBox.style.display = "none";
    publishBox.style.display = "none";
  }
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* =============================
   INIT UI
============================= */
(function init(){
  rTrade.innerHTML = TRADES.map(t => `<option value="${t}">${t}</option>`).join("");

  const savedPhone = localStorage.getItem("DIGIY_JEF_PHONE") || "";
  if(savedPhone) pillPhone.innerHTML = `üìû <strong>${savedPhone}</strong>`;
})();

/* =============================
   LOGIN
============================= */
btnDemo.onclick = ()=>{
  iPhone.value = "+221771234567";
  iPin.value = "1234";
  showNote(loginNote, "‚úÖ Demo rempli. Clique ‚ÄúEntrer‚Äù.", "ok");
};

btnEnter.onclick = async ()=>{
  hideNote(loginNote);
  hideNote(pubNote);

  const phone = normalizePhone(iPhone.value);
  const pin = String(iPin.value||"").trim();

  if(!phone || phone.length < 10) return showNote(loginNote, "‚ùå T√©l√©phone invalide.", "bad");
  if(!/^\d{4}$/.test(pin)) return showNote(loginNote, "‚ùå PIN invalide (4 chiffres).", "bad");

  btnEnter.disabled = true;
  btnEnter.textContent = "‚Ä¶";

  try{
    const secret = await deriveSecret(phone, pin);
    localStorage.setItem("DIGIY_JEF_PHONE", phone);
    localStorage.setItem("DIGIY_JEF_SECRET", secret);
    SB = makeClient();

    pillPhone.innerHTML = `üìû <strong>${phone}</strong>`;
    // pr√©-rempli contact
    rContact.value = phone;

    setConnected(true);
    showNote(loginNote, "‚úÖ OK. Tu es connect√©.", "ok");

    await loadPublicRecruiterOffers();
  }catch(e){
    console.error(e);
    showNote(loginNote, "‚ùå Erreur: " + (e?.message || e), "bad");
  }finally{
    btnEnter.disabled = false;
    btnEnter.textContent = "‚úÖ Entrer";
  }
};

btnReset.onclick = ()=>{
  if(!confirm("Changer t√©l√©phone / PIN ? (√ßa d√©connecte ce tel)")) return;
  localStorage.removeItem("DIGIY_JEF_PHONE");
  localStorage.removeItem("DIGIY_JEF_SECRET");
  pillPhone.innerHTML = "üìû <strong>‚Äî</strong>";
  setConnected(false);
  showNote(loginNote, "‚ÑπÔ∏è D√©connect√©. Mets ton t√©l√©phone + PIN.", "warn");
};

btnLogout.onclick = ()=>{
  localStorage.removeItem("DIGIY_JEF_PHONE");
  localStorage.removeItem("DIGIY_JEF_SECRET");
  pillPhone.innerHTML = "üìû <strong>‚Äî</strong>";
  setConnected(false);
  showNote(loginNote, "‚úÖ D√©connect√©.", "ok");
};

/* =============================
   PUBLISH (kind=recruteur)
============================= */
btnPublish.onclick = async ()=>{
  hideNote(pubNote);

  const phone = localStorage.getItem("DIGIY_JEF_PHONE") || "";
  const secret = localStorage.getItem("DIGIY_JEF_SECRET") || "";
  if(!phone || !secret) return showNote(pubNote, "‚ùå Reconnecte-toi (tel + PIN).", "bad");

  const name = rName.value.trim();
  const city = rCity.value.trim();
  const trade = rTrade.value;
  const type = rType.value;
  const avail = rAvail.value;
  const title = rTitle.value.trim();
  const msg = rMsg.value.trim();
  const contact = normalizePhone(rContact.value) || phone;

  if(name.length < 2) return showNote(pubNote, "‚ùå Mets un nom (min 2).", "bad");
  if(city.length < 2) return showNote(pubNote, "‚ùå Mets la ville.", "bad");
  if(!trade) return showNote(pubNote, "‚ùå Choisis un m√©tier.", "bad");
  if(title.length < 8) return showNote(pubNote, "‚ùå Titre trop court (min 8).", "bad");
  if(msg.length < 20) return showNote(pubNote, "‚ùå D√©tails trop courts (min 20).", "bad");

  btnPublish.disabled = true;
  btnPublish.textContent = "‚Ä¶";

  try{
    const payload = {
      owner_phone: phone,
      owner_secret: secret,
      kind: "recruteur",
      title,
      trade,
      availability: avail,
      message: msg,
      city_hint: city,
      contact_phone: contact,
      meta: { recruiter_name: name, offer_type: type }
    };

    const { error } = await SB.from("jef_offers").insert(payload);
    if(error) throw error;

    showNote(pubNote, "‚úÖ Annonce publi√©e! Les apprentis peuvent te contacter.", "ok");
    rTitle.value = "";
    rMsg.value = "";
    await loadPublicRecruiterOffers();
  }catch(e){
    console.error(e);
    showNote(pubNote, "‚ùå Publication refus√©e:\n" + (e?.message || e), "bad");
  }finally{
    btnPublish.disabled = false;
    btnPublish.textContent = "üöÄ Publier";
  }
};

btnRefresh.onclick = ()=> loadPublicRecruiterOffers();

/* =============================
   LIST PUBLIC (kind=recruteur)
============================= */
async function loadPublicRecruiterOffers(){
  hideNote(listNote);
  list.innerHTML = "";
  countTag.textContent = "‚Ä¶";

  try{
    const { data, error } = await SB
      .from("jef_offers")
      .select("id,kind,title,trade,availability,message,city_hint,contact_phone,created_at,meta")
      .eq("kind","recruteur")
      .order("created_at", { ascending:false })
      .limit(30);

    if(error) throw error;

    const rows = data || [];
    countTag.textContent = `${rows.length} annonce(s)`;

    if(rows.length === 0){
      return showNote(listNote, "‚ÑπÔ∏è Aucune annonce recruteur pour l‚Äôinstant.", "warn");
    }

    rows.forEach(r=>{
      const d = (r.created_at||"").slice(0,16).replace("T"," ");
      const city = r.city_hint ? `üìç ${r.city_hint}` : "";
      const phone = r.contact_phone ? `üìû ${r.contact_phone}` : "";
      const recruiterName = r.meta && r.meta.recruiter_name ? r.meta.recruiter_name : "";
      const offerType = r.meta && r.meta.offer_type ? r.meta.offer_type : "";

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="itemTop">
          <strong>${escapeHtml(r.title||"Annonce")}</strong>
          <span class="tag ok">üõ†Ô∏è ${escapeHtml(r.trade||"")}</span>
        </div>
        <div class="itemSub">
          ${recruiterName ? "üë§ <strong>"+escapeHtml(recruiterName)+"</strong><br>" : ""}
          ${offerType ? "üìå "+escapeHtml(offerType)+"<br>" : ""}
          ${city ? city + "<br>" : ""}
          ‚è±Ô∏è ${escapeHtml(r.availability||"")} ‚Ä¢ üïí ${escapeHtml(d)}<br>
          ${escapeHtml((r.message||"").slice(0,260))}${(r.message||"").length>260 ? "‚Ä¶" : ""}<br>
          ${phone ? "<br><strong>"+escapeHtml(phone)+"</strong>" : ""}
        </div>
      `;
      list.appendChild(div);
    });
  }catch(e){
    console.error(e);
    countTag.textContent = "‚Äî";
    showNote(listNote, "‚ö†Ô∏è Liste indisponible (table/policies ?).\nErreur: " + (e?.message || e), "warn");
  }
}

/* =============================
   BOOT
============================= */
(function boot(){
  const phone = localStorage.getItem("DIGIY_JEF_PHONE") || "";
  const secret = localStorage.getItem("DIGIY_JEF_SECRET") || "";

  if(phone && secret){
    pillPhone.innerHTML = `üìû <strong>${phone}</strong>`;
    rContact.value = phone;
    setConnected(true);
    loadPublicRecruiterOffers();
  }else{
    setConnected(false);
    loadPublicRecruiterOffers(); // public
  }
})();
</script>
</body>
</html>
